<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="utf-8" />

    <title>URDF Viewer Example</title>

    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
    <script src="../node_modules/three/build/three.js"></script>
    <script src="../node_modules/three/examples/js/controls/OrbitControls.js"></script>
    <script src="../node_modules/three/examples/js/loaders/GLTFLoader.js"></script>
    <script src="../node_modules/three/examples/js/loaders/OBJLoader.js"></script>
    <script src="../node_modules/three/examples/js/loaders/STLLoader.js"></script>
    <script src="../node_modules/three/examples/js/loaders/ColladaLoader.js"></script>
    <script src="../node_modules/threejs-model-loader/ModelLoader.js"></script>
    <script src="../umd/URDFLoader.js"></script>


    <script src="../umd/urdf-viewer-element.js"></script>
    <script src="../umd/urdf-manipulator-element.js"></script>
    <script>
        /* globals URDFViewer */
        customElements.define('urdf-viewer', URDFManipulator)
    </script>

    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300" rel="stylesheet" />
    <link href="../example/styles.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap');

        .inputrow {
            width: 100%;
            display: flex;
            flex-flow: row;
            justify-content: space-between;
        }

        * {
            font-family: "Rajdhani", sans-serif;
        }

        li {
            border-radius: 0.25rem;
        }

        input[type="text"] {
            color: white;
            border: none;
            font-weight: 300;
            background: rgba(255, 255, 255, 0.25);
            padding: 1px 2px;
        }

        select {
            border-radius: 0.25rem;

            font-family: "Rajdhani", sans-serif;
        }

        input {
            border-radius: 0.25rem;
            color: white;
        }

        input::placeholder{
            color:#fffa;
        }
        #joint-controls {
            display: flex;
            flex-flow: column;
            gap: 4px;
        }

        #controls {
            backdrop-filter: blur(10px)brightness(0.5);
            padding: 1rem;
            border-radius: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 4rem);
            margin-top:unset!important;

        }

        button {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: unset;
            padding: 1px 2px;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.5);
            color: white;
            border: unset;
            padding: 1px 2px;
            border-radius: 0.25rem;
        }
    </style>
</head>

<body tabindex="0">

    <div id="menu">
        <ul id="urdf-options" style="display:none;">
            <li urdf="../urdf/dropbear/urdf/dropbear.urdf" color="#3e4952">DROPBEAR</li>
            <li urdf="../urdf/TriATHLETE/urdf/TriATHLETE_flipped.URDF" color="#3e4952">TriATHLETE</li>
            <li urdf="../urdf/TriATHLETE_Climbing/urdf/TriATHLETE_flipped.URDF" color="#3e4952">TriATHLETE Climbing</li>
        </ul>


        <div id="controls" class="hidden">


            <div id="joint-controls">
                <label for="joint-selector">Select Joint:</label>
                <select id="joint-selector">
                </select>
                <div class="inputrow">
                    <label for="joint-position-xyz">Position (XYZ):</label>
                    <input type="text" id="joint-position-xyz" placeholder="x y z">
                </div>
                <div class="inputrow">
                    <label for="joint-origin-xyz">Origin (XYZ):</label>
                    <input type="text" id="joint-origin-xyz" placeholder="x y z">
                </div>
                <div class="inputrow">
                    <label for="joint-origin-rpy">Rotation (RPY):</label>
                    <input type="text" id="joint-origin-rpy" placeholder="roll pitch yaw">
                </div>
                <div class="inputrow">

                    <label for="joint-axis-xyz">Axis (XYZ):</label>
                    <input type="text" id="joint-axis-xyz" placeholder="x y z">
                </div>
                <div class="inputrow">

                    <label for="joint-lower-limit">Lower Limit:</label>
                    <input type="number" id="joint-lower-limit" step="0.01">
                </div>
                <div class="inputrow">


                    <label for="joint-upper-limit">Upper Limit:</label>
                    <input type="number" id="joint-upper-limit" step="0.01">
                </div>

                <button onclick="updateJointProperties()">Update Joint</button>
            </div>


            <div>Drag and drop a set of URDF files! <br /> (Chrome Only)</div>
            <div id="ignore-joint-limits" class="toggle">Ignore Joint Limits</div>
            <div id="do-animate" class="toggle checked">Animate Joints</div>
            <label>
                Up Axis
                <select id="up-select">
                    <option value="+X">+X</option>
                    <option value="-X">-X</option>
                    <option value="+Y" selected>+Y</option>
                    <option value="-Y">-Y</option>
                    <option value="+Z">+Z</option>
                    <option value="-Z">-Z</option>
                </select>
            </label>
            <ul></ul>
            <div id="toggle-controls"></div>

        </div>
    </div>
    <urdf-viewer up="+Y" display-shadow tabindex="0"></urdf-viewer>

    <script src="../example/index.js"></script>
    <script src="../example/dragAndDrop.js"></script>

    <script>
        /* eslint-disable */
        /* globals viewer */
        var DEG2RAD = Math.PI / 180;
        window.animToggle = document.getElementById('do-animate');

        const lerp = (from, to, ratio) => from + (to - from) * ratio;

        const updateAngles = () => {

            if (!viewer.setAngle) return;

            // reset everything to 0 first
            const resetangles = viewer.angles;
            for (const name in resetangles) resetangles[name] = 0;
            viewer.setAngles(resetangles);

            // animate the legs
            const time = Date.now() / 3e2;
            for (let i = 1; i <= 6; i++) {

                const offset = i * Math.PI / 3;
                const ratio = Math.max(0, Math.sin(time + offset));

                viewer.setAngle(`HP${i}`, lerp(30, 0, ratio) * DEG2RAD);
                viewer.setAngle(`KP${i}`, lerp(90, 150, ratio) * DEG2RAD);
                viewer.setAngle(`AP${i}`, lerp(-30, -60, ratio) * DEG2RAD);

                viewer.setAngle(`TC${i}A`, lerp(0, 0.065, ratio));
                viewer.setAngle(`TC${i}B`, lerp(0, 0.065, ratio));

                viewer.setAngle(`W${i}`, window.performance.now() * 0.001);

            }

        };

        const updateLoop = () => {

            if (animToggle.classList.contains('checked')) {
                updateAngles();
            }

            requestAnimationFrame(updateLoop);

        };

        document.querySelectorAll('#urdf-options li[urdf]').forEach(el => {

            el.addEventListener('click', e => {

                const urdf = e.target.getAttribute('urdf');
                const color = e.target.getAttribute('color');

                viewer.up = '+Y';
                document.getElementById('up-select').value = viewer.up;
                viewer.urdf = urdf;
                animToggle.classList.add('checked');
                setColor(color);

            });

        });

        document.addEventListener('WebComponentsReady', () => {

            animToggle.addEventListener('click', () => animToggle.classList.toggle('checked'));

            // stop the animation if user tried to manipulate the model
            viewer.addEventListener('manipulate-start', e => animToggle.classList.remove('checked'));
            viewer.addEventListener('urdf-processed', e => updateAngles());
            updateLoop();
            viewer.camera.position.set(-5.5, 3.5, 5.5);

        });
    </script>

    <script>
        // Function to update the joint properties based on user input
        // Assuming 'viewer' has a method to get the current robot model and 'robot' is an instance of URDFRobot
        function updateJointProperties() {
            const jointName = document.getElementById('joint-selector').value;
            const originXYZ = document.getElementById('joint-origin-xyz').value.split(' ').map(Number);
            const originRPY = document.getElementById('joint-origin-rpy').value.split(' ').map(v => parseFloat(v) * Math.PI / 180);
            const positionXYZ = document.getElementById('joint-position-xyz').value.split(' ').map(Number); // Assuming you have a UI input for this
            const axisXYZ = document.getElementById('joint-axis-xyz').value.split(' ').map(Number);
            const lowerLimit = parseFloat(document.getElementById('joint-lower-limit').value) * Math.PI / 180;
            const upperLimit = parseFloat(document.getElementById('joint-upper-limit').value) * Math.PI / 180;

            if (viewer && viewer.robot && viewer.robot.joints[jointName]) {
                const joint = viewer.robot.joints[jointName];

                // Convert RPY to a Quaternion
                const quaternion = new THREE.Quaternion();
                const euler = new THREE.Euler(...originRPY, 'XYZ');
                quaternion.setFromEuler(euler);

                // Update joint properties
                joint.origPosition.set(originXYZ[0], originXYZ[1], originXYZ[2]); // Assuming the joint class has origPosition
                joint.origQuaternion = quaternion; // Assuming the joint class has origQuaternion
                joint.axis = new THREE.Vector3(...axisXYZ);
                joint.limit = { lower: lowerLimit, upper: upperLimit };
                joint.position.set(positionXYZ[0], positionXYZ[1], positionXYZ[2]);

                console.log(joint);
                // Refresh scene to apply changes
                refreshScene();


            } else {
                console.error("Joint not found or viewer not initialized properly.");
            }
        }

        function refreshScene() {
            if (viewer && typeof viewer.updateScene === 'function') {
                viewer.updateScene(); // Assuming your viewer has an 'updateScene' method
            } else {
                // Fallback: manually trigger the necessary updates and re-render
                viewer.scene.updateMatrixWorld(true);
                if (viewer.controls) {
                    viewer.controls.update(); // Update controls after modifying the scene
                }
                if (typeof render === 'function') {
                    render(); // Call your rendering function if it's defined
                }
            }
        }

        function loadJointDetails() {
            const jointSelector = document.getElementById('joint-selector');
            const jointName = jointSelector.value;

            if (viewer && viewer.robot && viewer.robot.joints[jointName]) {
                const joint = viewer.robot.joints[jointName];

                // Assuming that joint.origin, joint.origQuaternion, and joint.position are available
                document.getElementById('joint-origin-xyz').value = joint.origPosition.toArray().join(' ');
                //document.getElementById('joint-origin-rpy').value = (new THREE.Euler().setFromQuaternion(joint.origQuaternion, 'XYZ')).toArray().map(r => (r * 180 / Math.PI).toFixed(2));
                document.getElementById('joint-position-xyz').value = joint.position.toArray().join(' ');
                //document.getElementById('joint-axis-xyz').value = joint.axis.toArray().join(' ');
                document.getElementById('joint-lower-limit').value = (joint.limit.lower * 180 / Math.PI).toFixed(2);
                document.getElementById('joint-upper-limit').value = (joint.limit.upper * 180 / Math.PI).toFixed(2);
            } else {
                console.error("Joint not found or viewer not initialized properly.");
            }
        }

        function populateJointNames() {
            const jointSelector = document.getElementById('joint-selector');
            if (viewer && viewer.robot) {
                jointSelector.innerHTML = ''; // Clear existing options
                Object.keys(viewer.robot.joints).forEach(jointName => {
                    const option = document.createElement('option');
                    option.value = jointName;
                    option.textContent = jointName;
                    jointSelector.appendChild(option);
                });
                loadJointDetails(); // Load details of the first joint
            }
        }

        viewer.addEventListener('joint-mouseover', e => {
    const jointName = e.detail; // Assuming `e.detail` contains the name of the hovered joint
    const jointSelector = document.getElementById('joint-selector');
    const jointOption = document.querySelector(`#joint-selector option[value="${jointName}"]`);
    const j = document.querySelector(`li[joint-name="${jointName}"]`);

    if (j) {
        j.setAttribute('robot-hovered', true);
    }

    // Check if the option exists in the select dropdown, if not, create and append it
    if (!jointOption) {
        let newOption = document.createElement("option");
        newOption.value = jointName;
        newOption.textContent = jointName;
        jointSelector.appendChild(newOption);
    }

    // Set the select element's value to the hovered joint name
    jointSelector.value = jointName;
    loadJointDetails(); // Load details of the first joint

});

        document.addEventListener('DOMContentLoaded', () => {
        // Assuming URDFViewer is already initialized and populated with the robot model
        setTimeout(() => {
            populateJointNames();
            document.getElementById('joint-selector').addEventListener('change', loadJointDetails);
            
            // Add listener to the viewer for joint click events
            if (viewer) {
                viewer.addEventListener('joint-click', function(e) {
                    const jointName = e.detail; // Assuming the event detail contains the joint name
                    const jointSelector = document.getElementById('joint-selector');
                    jointSelector.value = jointName;
                    loadJointDetails(); // Load the details of the clicked joint into the input fields
                });
            }
        }, 2000); // Ensure URDF data is loaded and delay to setup the event listener
    });


    </script>

</body>

</html>